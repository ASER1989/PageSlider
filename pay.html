<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <title>pay</title>
    <link rel="stylesheet" href="./css/pay.css">
    <link rel="stylesheet" href="./css/page-slider.css?v=1A">

</head>
<body>
<div id="pay-page" class="hide">
    <div class="card">
        <div class="product">
            捐赠共勉
        </div>
        <div id="proAttr" class="proAttr">
            <div data-val="100" class="check hobbyAnimate" data-move="true" data-delcls="hobbyAnimate" data-delay="800">基础版</div>
            <div class="hobbyAnimate" data-val="1000" data-move="true"  data-delcls="hobbyAnimate"  data-delay="1000">标准版</div>
            <div class="hobbyAnimate" data-val="10000" data-move="true"  data-delcls="hobbyAnimate"  data-delay="1200">豪放版</div>
        </div>
    </div>
    <div class="bottom bottom-leave" data-move="true" data-delay="1200" data-delcls="bottom-leave">
        <div class="info">
            <span> RMB: <label id="_price">1</label> x </span>
            <select id="_pnum">
                <option value="1">&nbsp;1</option>
                <option value="2">&nbsp;2</option>
                <option value="3">&nbsp;3</option>
                <option value="4">&nbsp;4</option>
                <option value="5">&nbsp;5</option>
                <option value="6">&nbsp;6</option>
                <option value="7">&nbsp;7</option>
                <option value="8">&nbsp;8</option>
                <option value="9">&nbsp;9</option>
                <option value="10">&nbsp;10</option>
            </select>
        </div>
        <div>
            <a id="_paybutt" class="paybutt" href="javascript:void(0)">支付一个</a>
        </div>
    </div>
</div>
<script type="text/javascript" src="js/me.require.js"></script>
<script type="text/javascript">
    require(["http://res.wx.qq.com/open/js/jweixin-1.0.0.js","./js/page-move.js",'./js/zepto.js','./js/zoom.js','./js/page-loading.js','./js/page-dialog.js'], function () {
        new zoom($).calc();
        var loading = loader();
        var dialog = dialoger();
        var pmove = new move("#pay-page");

        $.ajax({
            url: "/demo/WxInit",
            data: {url: window.location.href},
            success: function (data) {
                data = JSON.parse(data);
                wx.config({
                    debug: false,
                    appId: data.appId,
                    timestamp: data.timestamp,
                    nonceStr: data.nonceStr,
                    signature: data.signature,
                    jsApiList: [
                        'checkJsApi',
                        'onMenuShareTimeline',
                        'onMenuShareAppMessage',
                        'onMenuShareQQ',
                        'onMenuShareWeibo',
                        'onMenuShareQZone',
                        'hideMenuItems',
                        'showMenuItems',
                        'hideAllNonBaseMenuItem',
                        'showAllNonBaseMenuItem',
                        'translateVoice',
                        'startRecord',
                        'stopRecord',
                        'onVoiceRecordEnd',
                        'playVoice',
                        'onVoicePlayEnd',
                        'pauseVoice',
                        'stopVoice',
                        'uploadVoice',
                        'downloadVoice',
                        'chooseImage',
                        'previewImage',
                        'uploadImage',
                        'downloadImage',
                        'getNetworkType',
                        'openLocation',
                        'getLocation',
                        'hideOptionMenu',
                        'showOptionMenu',
                        'closeWindow',
                        'scanQRCode',
                        'chooseWXPay',
                        'openProductSpecificView',
                        'addCard',
                        'chooseCard',
                        'openCard'
                    ]
                });

                wx.ready(function () {

                    $("#pay-page").removeClass("hide");
                    pmove.start();

                    var price = $("#_price"), hobby = 100;
                    $("#proAttr div").on("click", function () {
                        var that = $(this);
                        that.parent().find("div").removeClass("check");
                        that.addClass("check");
                        price.html(that.attr("data-val") / 100);
                        hobby = that.attr("data-val")
                    });

                    $("#_paybutt").on("click", function () {
                        var amt =Number(hobby)*$("#_pnum").val();
                        loading.show();
                        $.ajax({
                            url: "/demo/GetPayConfig",
                            dataType: "json",
                            data: {amt: amt},
                            success: function (data) {
                                loading.hide();
                                try {
                                    var config = data;
                                    config.timestamp = Number(config.timeStamp);
                                    config.success = function () {
                                        dialog.show("消息","感谢您的馈赠！",{"text-align":"center","padding-top":"30px"});
                                        paySuccess(amt)
                                    }

                                    wx.chooseWXPay(config);
                                } catch (e) {

                                }
                            }
                        });
                    });

                    function paySuccess(amt){
                        $.ajax({
                            url:"/demo/paysuccess",
                            data:{amt:amt},
                            success:function(){

                            }
                        })
                    }

                    onShare(wx,'黄旭-小作品','http://aser.src.demo.ahyunhe.com/demo/payinit','http://aser.src.demo.ahyunhe.com/src/res/100.jpg');
                });
            }

        })

        function onShare(wx,title,link,img){
            wx.onMenuShareTimeline({
                title: title, // 分享标题
                link: link, // 分享链接
                imgUrl: img, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

            wx.onMenuShareAppMessage({
                title: title, // 分享标题
                desc: title, // 分享描述
                link: link, // 分享链接
                imgUrl: img, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
        }
    });
</script>
</body>
</html>
